digraph state_machine {
  node[fontsize=15, color=black, width=3, height=1];

  // states
  blank [style=invis, height=0];
  init [label="m:\lCardinality(connections[m]) < MAX\nn \\notin blacklist[m]\nn \\notin connections[m]\nn \\notin handshaking[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin blacklist[n]\nm \\notin connections[n]\nm \\notin handshaking[n]\n\n"];
  requested [label="m:\lCardinality(connections[m]) < MAX\nn \\notin connections[m]\nn \\in handshaking[m]\nn \\notin receive_conn_msg[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin connections[n]\nm \\notin handshaking[n]\nm \\notin receive_conn_msg[n]\n\nmsg == conn_msg(m)\nmsg \\in messages[n]\n\n"];
  received [label="m:\lCardinality(connections[m]) < MAX\nn \\notin connections[m]\nn \\notin handshaking[m]\nn \\notin receive_conn_msg[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin connections[n]\nm \\in handshaking[n]\nm \\notin receive_conn_msg[n]\n\nmsg == conn_msg(n)\nmsg \\in messages[m]\n\n"];
  requested [label="m:\lCardinality(connections[m]) < MAX\nn \\notin connections[m]\nn \\in handshaking[m]\nn \\notin receive_conn_msg[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin connections[n]\nm \\notin handshaking[n]\nm \\notin receive_conn_msg[n]\n\nmsg == conn_msg(m)\nmsg \\in messages[n]\n\n"];
  received [label="m:\lCardinality(connections[m]) < MAX\nn \\notin connections[m]\nn \\notin handshaking[m]\nn \\notin receive_conn_msg[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin connections[n]\nm \\in handshaking[n]\nm \\notin receive_conn_msg[n]\n\nmsg == conn_msg(n)\nmsg \\in messages[m]\n\n"];
  req_rec [label="m:\lCardinality(connections[m]) < MAX\nn \\notin connections[m]\nn \\in handshaking[m]\nn \\in receive_conn_msg[m]\n\nn:\lCardinality(connections[n]) < MAX\nm \\notin connections[n]\nm \\in handshaking[n]\nm \\in receive_conn_msg[n]\n\n"];
  ack [label="m:\lCardinality(connections[m]) <= MAX\nn \\in connections[m]\n\nn:\lCardinality(connections[n]) < MAX\n\n"];
  connected [label="m:\lCardinality(connections[m]) <= MAX\n\nn:\lCardinality(connections[n]) <= MAX\nn \\in connections[m]\nm \\in connections[n]\n\n"];

  // transitions
  blank -> init;
  init -> requested [label="send_conn_msg(m, n)    "];
  init -> received [label="  send_conn_msg(n, m)    "];
  requested -> send_rec [label="  handle_conn_msg(n, m, msg)     "];
  received -> rec_send [label="  handle_conn_msg(m, n, msg)  "];
  send_rec -> req_rec [label="  handle_conn_msg(n, m, msg)     "];
  rec_send -> req_rec [label="  handle_conn_msg(m, n, msg)  "];
  req_rec -> init [label="  Nack"];
  req_rec -> ack [label="  Ack"];
  ack -> connected [label="  Ack"];
  ack -> init [label="  Nack"];

}
