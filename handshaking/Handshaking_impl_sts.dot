digraph Handshaking_impl {
    
  // states
  init;
  write_ok;
  read_ok [label="read_ok"];
  incoming_false [label="remote_listening_port = remote_socket_port"];
  incoming_true [label="remote_listening_port = msg.port"];
  gen_meta [label="metadata generated"];
  write_meta_ok;
  authorized [label="connection\nauthorized"];
  accepted [label="connection\naccepted"];
  accept_wait [label="waiting for\nresponse"];
  rejected [label="connection\nrejected"];

  // transitions
  init -> init [label="write_error"];
  init -> write_ok [label="write_ok"];
  write_ok -> init [label="read_error"];
  write_ok -> read_ok [label="read_ok"];
  read_ok -> incoming_false [label="incoming = false"];
  read_ok -> incoming_true [label="incoming = true"];
  incoming_false -> init [label="Myself_error\nNot_enough_pow_error"];
  incoming_false -> gen_meta [label="generate metadata"];
  incoming_true -> init [label="Myself_error\nNot_enough_pow_error"];
  incoming_true -> gen_meta [label="generate metadata"];
  gen_meta -> init [label="meta_write_error"];
  gen_meta -> write_meta_ok [label="meta_write_ok"];
  write_meta_ok -> init [label="meta_read_error"];
  write_meta_ok -> authorized [label="meta_read_ok"];
  authorized -> accept_wait [label="accept"];
  authorized -> rejected [label="reject"];
  accept_wait -> accepted [label="accept"];
  accept_wait -> rejected [label="reject"];

}
